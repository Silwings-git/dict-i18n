# 🔌 Dict-I18n 启动器(Spring Boot Starter)说明

## 📘 概述

`dict-i18n` 提供了专门的 Spring Boot Starter，通过自动配置机制简化框架在 Spring Boot 应用中的集成。核心围绕
`DictI18nAutoConfiguration` 类实现，当启动器被引入应用时，会自动配置所有必要的 Bean，无需手动编写繁琐的初始化代码。

该 Starter 实现了加载器的自动注册、字典扫描、REST 端点暴露等核心功能，并支持通过配置灵活调整行为，完全适配 Spring Boot 的"
约定大于配置"理念。

---

## 🔧 自动配置架构

### 核心自动配置类

自动配置的核心是 `DictI18nAutoConfiguration`，它负责：

- 根据配置条件注册关键 Bean
- 协调加载器排序、字典扫描等组件的初始化
- 注册 REST 端点处理器
- 集成语言提供器等扩展点

### 自动配置 Bean 依赖关系

Starter 通过条件注解（`@Conditional`）根据配置动态注册 Bean，确保组件按需加载。核心 Bean 及其依赖关系如下：

| Bean 名称                    | 生效条件                                                    | 功能用途                 |
|----------------------------|---------------------------------------------------------|----------------------|
| `DictLoaderConfigSorter`   | `dict-i18n.loader-order[0]` 存在                          | 根据配置对加载器进行优先级排序      |
| `SpringDictLoaderSorter`   | 不存在 `DictLoaderSorter` 类型 Bean                          | 提供默认的加载器排序实现         |
| `UniqueDictNameChecker`    | `dict-i18n.starter.check.unique-dict-name.enabled=true` | 验证字典名称的唯一性，防止冲突      |
| `DictMapHolder`            | `dict-i18n.starter.endpoint.enabled=true`               | 作为字典枚举的中央注册表，支持端点查询  |
| `DictItemsEndpointHandler` | `dict-i18n.starter.endpoint.dict-items.enabled=true`    | 处理字典项查询的 REST 端点处理器  |
| `DictNamesEndpointHandler` | `dict-i18n.starter.endpoint.dict-names.enabled=true`    | 处理字典名称查询的 REST 端点处理器 |

---

## ⚙️ 配置属性

Starter 提供了丰富的配置项，所有属性均以 `dict-i18n.starter` 为前缀，支持在 `application.yml` 或 `application.properties`
中配置。

### 核心配置项

```yaml
dict-i18n:
  starter:
    scan-packages: [ ]  # 扫描 Dict 实现类的包路径
    check:
      unique-dict-name:
        enabled: true  # 是否启用字典名称唯一性校验
    endpoint:
      enabled: true  # 是否启用 REST 端点
      dict-items:
        enabled: true  # 是否启用字典项端点
        path: /dict-i18n/dict-items  # 字典项端点路径
      dict-names:
        enabled: true  # 是否启用字典名称端点
        path: /dict-i18n/dict-names  # 字典名称端点路径
    enhancer:
      enabled: true  # 是否启用响应增强
      include-packages: [ ]  # 需要增强的包路径
      exclude-annotations: [ ]  # 排除增强的注解
```

### 配置项详情

| 属性路径                             | 类型             | 默认值                     | 描述说明                    |
|----------------------------------|----------------|-------------------------|-------------------------|
| `scan-packages`                  | `List<String>` | 空列表                     | 指定需要扫描 `Dict` 接口实现类的包路径 |
| `check.unique-dict-name.enabled` | `boolean`      | `true`                  | 是否在启动时校验所有字典名称的唯一性      |
| `endpoint.enabled`               | `boolean`      | `true`                  | 是否启用 REST 端点功能          |
| `endpoint.dict-names.enabled`    | `boolean`      | `true`                  | 是否启用字典名称查询端点            |
| `endpoint.dict-names.path`       | `String`       | `/dict-i18n/dict-names` | 字典名称端点的访问路径             |
| `endpoint.dict-items.enabled`    | `boolean`      | `true`                  | 是否启用字典项查询端点             |
| `endpoint.dict-items.path`       | `String`       | `/dict-i18n/dict-items` | 字典项端点的访问路径              |
| `enhancer.enabled`               | `boolean`      | `true`                  | 是否启用响应增强（自动替换字典码为描述）    |
| `enhancer.include-packages`      | `List<String>` | []                      | 需要进行响应增强的包路径（为空时全部生效）   |
| `enhancer.exclude-annotations`   | `List<String>` | []                      | 排除响应增强的注解（标注该注解的类不增强）   |

---

## 🌐 REST 端点

Starter 内置两个 REST 端点，用于以编程方式查询字典数据，方便前端或其他服务获取国际化信息。

注意: REST 端点只处理枚举类型的Dict实现!!!

### 字典名称端点（Dict Names Endpoint）

#### 功能

查询系统中所有可用的字典名称。

#### 响应格式

```json
[
  "order_status",
  "product_type"
]
```

### 字典项端点（Dict Items Endpoint）

路径: `/dict-i18n/dict-items`

#### 功能

查询指定字典的所有项及其翻译文本()。

#### 请求参数

- `dictNames`：必填，以逗号分隔的字典名称列表（如 `order_status,product_type`）
- `language`：可选，语言代码（如 `zh-cn`、`en`），默认使用当前上下文语言

#### 响应格式

```json
{
  "items": {
    "order_status": [
      {
        "code": "pending",
        "desc": "待处理"
      },
      {
        "code": "completed",
        "desc": "已完成"
      }
    ],
    "product_type": [
      {
        "code": "physical",
        "desc": "实物商品"
      },
      {
        "code": "digital",
        "desc": "数字商品"
      }
    ]
  }
}
```

### 端点注册机制

端点通过 `SimpleUrlHandlerMapping` 注册为 Spring MVC 处理器，核心代码如下：

```java
private HandlerMapping buildHandlerMapping(final String path, final HttpRequestHandler handler) {
    final Map<String, HttpRequestHandler> urlMap = new HashMap<>();
    urlMap.put(path, handler);
    final SimpleUrlHandlerMapping mapping = new SimpleUrlHandlerMapping();
    mapping.setUrlMap(urlMap);
    mapping.setOrder(0);
    return mapping;
}
```

该机制确保端点可以直接响应 HTTP 请求，无需额外的控制器配置。

---

## 🧩 核心集成组件

### DictMapHolder

#### 功能

作为字典枚举的中央注册表，在应用启动时收集所有 `Dict` 接口枚举实现类，并提供查询能力。

#### 核心职责

- 扫描指定包路径下的 `Dict` 枚举实现类
- 使用线程安全的 `ConcurrentHashMap<String, Dict[]>` 存储字典名称与枚举常量的映射
- 为 REST 端点提供字典数据查询接口
- 实现 `ApplicationRunner` 接口，在 Spring 上下文加载完成后执行初始化

#### 初始化流程

1. 根据配置确定需要扫描的包路径（优先使用 `scan-packages` 配置，默认使用自动配置包）
2. 通过 `DictScanner` 查找所有实现 `Dict` 接口的枚举类
3. 将枚举常量按 `dictName()` 方法返回的名称注册到映射表中

### UniqueDictNameChecker

#### 功能

在应用启动时校验所有字典名称的唯一性，防止多个枚举使用相同的字典名称导致运行时冲突。

#### 校验逻辑

1. 使用 `DictScanner` 扫描所有 `Dict` 实现类
2. 收集所有枚举常量的字典名称
3. 若发现重复名称，立即抛出异常终止启动（快速失败机制）

### 语言提供器集成

Starter 提供默认的 `DefaultLanguageProvider` 实现，用于获取当前上下文的语言信息。若需自定义语言检测逻辑（如从请求头、用户配置中获取语言），可通过实现
`LanguageProvider` 接口并注册为 Spring Bean 覆盖默认实现：

```java
@Bean
@ConditionalOnMissingBean(LanguageProvider.class)
public LanguageProvider defaultLangProvider() {
    return new DefaultLanguageProvider();
}
```

---

## 🔄 启动流程

### 应用启动序列

1. Spring Boot 应用启动，触发 `DictI18nAutoConfiguration` 自动配置
2. 根据配置条件注册必要的 Bean（加载器排序器、端点处理器等）
3. `DictMapHolder` 在 Spring 上下文初始化完成后执行扫描
4. 扫描指定包路径下的 `Dict` 实现类并注册到映射表
5. `UniqueDictNameChecker` 执行字典名称唯一性校验
6. REST 端点通过 `SimpleUrlHandlerMapping` 注册到 Spring MVC
7. 应用启动完成，所有组件就绪

### 扫描包路径解析逻辑

框架按以下优先级确定扫描包路径：

1. 优先使用 `dict-i18n.starter.scan-packages` 配置的包路径
2. 若未配置，默认使用 Spring Boot 自动配置的包路径（`AutoConfigurationPackages.get(applicationContext)`）

核心代码：

```java
private List<String> getScanPackages() {
    return this.dictI18nStarterProperties.getScanPackages().isEmpty()
            ? AutoConfigurationPackages.get(this.applicationContext)
            : this.dictI18nStarterProperties.getScanPackages();
}
```

---

## 🛡️ 错误处理

Starter 内置多项保护机制，确保系统稳定运行：

- **缺失字典处理**：查询不存在的字典时返回空数组，避免返回 `null` 导致空指针异常
- **无效配置处理**：通过条件 Bean 注册机制，自动跳过无效配置的组件
- **启动失败处理**：`UniqueDictNameChecker` 在校验到重复字典名称时快速失败，避免运行时错误
- **端点安全处理**：端点默认启用，可通过配置关闭，防止未授权访问

---

| [< 快速开始](../guide/快速开始.md) | [加载器说明 >](../loader/加载器说明.md) |
|:---------------------------|------------------------------:|