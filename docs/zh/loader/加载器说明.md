# ğŸ§© Dict-I18n åŠ è½½å™¨ï¼ˆLoaderï¼‰è¯´æ˜

## ğŸ“˜ æ¦‚è¿°

`dict-i18n` æ”¯æŒå¤šç§å­—å…¸åŠ è½½æ–¹å¼ï¼Œå¼€å‘è€…å¯æ ¹æ®ç³»ç»Ÿå®é™…éœ€æ±‚çµæ´»é€‰ç”¨é€‚é…çš„åŠ è½½å™¨ã€‚åŠ è½½å™¨ä½œä¸ºè¿æ¥å¤–éƒ¨æ•°æ®æºï¼ˆå¦‚æ–‡ä»¶ã€æ•°æ®åº“ã€Redisç­‰ï¼‰ä¸ç³»ç»Ÿçš„æ¡¥æ¢ï¼Œè´Ÿè´£è¯»å–å„ç±»æ•°æ®æºä¸­çš„å­—å…¸å†…å®¹ï¼Œå¹¶å°†å…¶æ ‡å‡†åŒ–è½¬æ¢åä¾›ç³»ç»Ÿè°ƒç”¨ã€‚

æ‰€æœ‰åŠ è½½å™¨å‡éµå¾ªç»Ÿä¸€æ¥å£è®¾è®¡ï¼ŒåŒæ—¶å†…ç½®ä¼˜å…ˆçº§æ§åˆ¶ã€ç¼“å­˜æœºåˆ¶åŠæ ¼å¼æ‰©å±•èƒ½åŠ›ï¼Œç¡®ä¿åœ¨å¤šæ ·åŒ–åœºæ™¯ä¸‹çš„å…¼å®¹æ€§ä¸é«˜æ•ˆæ€§ã€‚ç³»ç»Ÿä¸ä»…é¢„è®¾äº†å¤šç§å¸¸ç”¨åŠ è½½å™¨ï¼Œæ›´é€šè¿‡æ’ä»¶åŒ–æ¶æ„æ”¯æŒè‡ªå®šä¹‰æ‰©å±•ï¼Œå¯è½»æ¾é€‚é…ä¸åŒä½“é‡ï¼ˆä»å°å‹åº”ç”¨åˆ°å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼‰åŠæ€§èƒ½éœ€æ±‚çš„å›½é™…åŒ–åœºæ™¯ï¼Œä¸ºå¤šè¯­è¨€ç³»ç»Ÿæä¾›çµæ´»ä¸”å¯é çš„å­—å…¸åŠ è½½è§£å†³æ–¹æ¡ˆã€‚

åŠ è½½å™¨æ¶æ„:
![LoaderArchitecture](LoaderArchitecture.png)

åŠ è½½å™¨æŸ¥è¯¢æµç¨‹:

```mermaid
sequenceDiagram
  participant App as Application
  participant DictI18nProcessor as DictI18nProcessor
  participant DictI18nProvider as DictI18nProvider
  participant DictI18nLoader as DictI18nLoader [1..*]
  participant DataSource as DataSource(æ–‡ä»¶/æ•°æ®åº“/Redis)
  App ->> DictI18nProcessor: è¯·æ±‚ç¿»è¯‘
  DictI18nProcessor ->> DictI18nProvider: getText(language, defaultLanguage, dictName, code)
  DictI18nProvider ->> DictI18nProvider: ç”ŸæˆlangChain ["zh-CN","zh",""]
  loop éå†æ¯ä¸ªåŠ è½½å™¨
    DictI18nProvider ->> DictI18nLoader: get(lang, dictKey)
    DictI18nLoader ->> DataSource: æ£€ç´¢ç¿»è¯‘
    DataSource -->> DictI18nLoader: ç¿»è¯‘æ•°æ®æˆ–ç©º
    DictI18nLoader -->> DictI18nProvider: è¿”å›ç»“æœ
    alt ç»“æœéç©º
      DictI18nProvider --x DictI18nLoader: ç»ˆæ­¢éå†
    end
  end

  DictI18nProvider -->> DictI18nProcessor: è¿”å›ç¬¬ä¸€ä¸ªéç©ºç»“æœ
  DictI18nProcessor -->> App: ç¿»è¯‘æ–‡æœ¬
```

---

## ğŸ§± åŠ è½½å™¨ç»“æ„ä¸æ‰©å±•æœºåˆ¶

åŠ è½½å™¨çš„æ ¸å¿ƒè¿ä½œæµç¨‹é€šå¸¸åŒ…å«ä»¥ä¸‹å…³é”®ç¯èŠ‚ï¼š

1. **æ•°æ®è¯»å–**ï¼šä»æŒ‡å®šæ•°æ®æºï¼ˆå¦‚æ–‡ä»¶ã€æ•°æ®åº“ã€Redis ç­‰ï¼‰æå–å­—å…¸åŸå§‹æ•°æ®ï¼›
2. **æ•°æ®è§£æ**ï¼šå°†å¼‚æ„çš„åŸå§‹æ•°æ®è½¬æ¢ä¸ºç³»ç»Ÿç»Ÿä¸€çš„æ ‡å‡†æ•°æ®ç»“æ„ï¼›
3. **ç¼“å­˜æ”¯æŒ**ï¼ˆå¯é€‰ï¼‰ï¼šå¯¹åŠ è½½åçš„ç»“æœå®æ–½æœ¬åœ°ç¼“å­˜ç­–ç•¥ï¼Œä»¥å‡å°‘é‡å¤åŠ è½½å¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼›
4. **æ¥æºåˆå¹¶**ï¼šå¤šåŠ è½½å™¨åœºæ™¯ä¸‹æ”¯æŒæŒ‰é…ç½®ä¼˜å…ˆçº§è¿›è¡Œæ•°æ®åˆå¹¶ä¸è¦†ç›–ï¼Œä¾åºæ‰§è¡ŒåŠ è½½é€»è¾‘ã€‚

æ‰€æœ‰åŠ è½½å™¨å‡éµå¾ªç»Ÿä¸€çš„DictI18nLoaderæ¥å£è§„èŒƒï¼ŒåŒæ—¶æ”¯æŒé€šè¿‡æ‰©å±•ç»„ä»¶æ‹“å±•åŠŸèƒ½è¾¹ç•Œï¼ˆè¯¦è§ä¸‹æ–‡è¯´æ˜ï¼‰ã€‚

---

## ğŸ“š å†…ç½®åŠ è½½å™¨ä¸€è§ˆ

| åŠ è½½å™¨åç§°         | æè¿°                         | é…ç½®é”®        | æ˜¯å¦æ”¯æŒç¼“å­˜ |
|---------------|----------------------------|------------|--------|
| **æ–‡ä»¶åŠ è½½å™¨**     | ä» yml / properties æ–‡ä»¶ä¸­åŠ è½½å­—å…¸ | `file`     | âœ…      |
| **æ•°æ®åº“åŠ è½½å™¨**    | é€šè¿‡ SQL æŸ¥è¯¢åŠ è½½å­—å…¸              | `sql`      | âœ…      |
| **Redis åŠ è½½å™¨** | ä» Redis ä¸­åŠ è½½å­—å…¸é¡¹             | `redis`    | âŒ      |
| **å£°æ˜å¼åŠ è½½å™¨**    | åœ¨ç±»ä¸­æ‰‹åŠ¨å£°æ˜å­—å…¸æè¿°                | `declared` | âŒ      |

åŠ è½½å™¨æœ‰å¦‚ä¸‹çš„å…¬å…±é…ç½®é¡¹

| é…ç½®é¡¹        | ç±»å‹      | é»˜è®¤å€¼  | è¯´æ˜        |
|------------|---------|------|-----------|
| enable     | boolean | true | æ˜¯å¦å¼€å¯å½“å‰åŠ è½½å™¨ |
| ignoreCase | boolean | true | æ˜¯å¦å¿½ç•¥å¤§å°å†™   |

æ­¤å¤–,æ¯ä¸ªåŠ è½½å™¨éƒ½æœ‰å¯¹åº”é…ç½®é¡¹ï¼Œå¹¶å¯æŒ‰éœ€å¼€å¯ã€ç¦ç”¨, è¯¦è§[é…ç½®è¯´æ˜](../config/é…ç½®è¯´æ˜.md)ã€‚

### åŠ è½½å™¨é€‰æ‹©æŒ‡å—

- é™æ€å­—å…¸ / æµ‹è¯•åœºæ™¯ï¼šä¼˜å…ˆé€‰æ‹© declared åŠ è½½å™¨æˆ– file åŠ è½½å™¨ï¼›
- åˆ†å¸ƒå¼ç³»ç»Ÿ / é«˜é¢‘è®¿é—®ï¼šä¼˜å…ˆé€‰æ‹© redis åŠ è½½å™¨ï¼›
- åŠ¨æ€æ›´æ–°éœ€æ±‚é«˜ï¼šä¼˜å…ˆé€‰æ‹© sql åŠ è½½å™¨ï¼ˆç»“åˆæ•°æ®åº“æ›´æ–°æœºåˆ¶ï¼‰ã€‚

---

## ğŸ“‚ æ–‡ä»¶åŠ è½½å™¨ï¼ˆfileï¼‰

* **åŠŸèƒ½**ï¼šæ”¯æŒä»æœ¬åœ°æˆ–è¿œç¨‹çš„ YMLã€Properties æ ¼å¼æ–‡ä»¶ä¸­è¯»å–å­—å…¸é¡¹ã€‚
* **ç¼“å­˜**: file åŠ è½½å™¨åœ¨é¡¹ç›®å¯åŠ¨æ—¶ä¼šåŠ è½½æ–‡ä»¶ä¸­çš„å…¨é‡æ•°æ®å¹¶ç¼“å­˜è‡³å†…å­˜ï¼Œä¸”ä¸æ”¯æŒè‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥ã€‚
* **å·¥ä½œæµç¨‹**:

  é¡¹ç›®å¯åŠ¨é˜¶æ®µ: file åŠ è½½å™¨ä¼šæ‰«æ resource ç›®å½•ä¸‹ç¬¦åˆå‘½åæ¨¡å¼ï¼ˆdict_i18n/dict_{locale} æˆ– dict_i18n/dictï¼‰
  çš„ yml æˆ– properties æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„å­—å…¸ç¿»è¯‘æ•°æ®å…¨é‡ç¼“å­˜è‡³å†…å­˜ï¼Œä¸æ”¯æŒè‡ªå®šä¹‰ç­–ç•¥ï¼ˆè‹¥åç»­åŠ è½½çš„æ–‡ä»¶ä¸­å­˜åœ¨é‡å¤çš„å­—å…¸
  keyï¼Œä¼šè¦†ç›–å…ˆå‰çš„æ•°æ®ï¼‰ï¼›

  æŸ¥è¯¢é˜¶æ®µ: æ¯æ¬¡è·å–å­—å…¸ç¿»è¯‘æ—¶ç›´æ¥ä»å†…å­˜ä¸­è¯»å–ã€‚

   ```mermaid
   sequenceDiagram
       title æ–‡ä»¶åŠ è½½å™¨åŠ è½½ä¸æŸ¥è¯¢æµç¨‹
       participant App as Application
       participant Loader as FileDictI18nLoader
       participant Parser as DictFileParser
       participant Strategy as DictFileParseStrategy
       participant Cache as Non-expired cache
       Note over App,Cache: é¡¹ç›®å¯åŠ¨é˜¶æ®µ
       App ->> Loader: åˆå§‹åŒ–
       Loader ->> Loader: loadAll()
       Loader ->> Loader: loadResourcesFromPattern()
       Loader ->> Loader: æ ¹æ®ä½ç½®æ¨¡å¼æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…æ–‡ä»¶
       loop å¯¹äºæ¯ä¸ªèµ„æº
           Loader ->> Loader: extractLangFromFilename()
           Loader ->> Loader: ä»æ–‡ä»¶åç¡®å®šè¯­è¨€ä»£ç <br/>(ä¾‹å¦‚: dict_en.yml --> "en")
           Loader ->> Parser: parse(resource)
           Parser ->> Strategy: getStrategy(resource)
           Strategy ->> Strategy: æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©YAMLæˆ–Propertiesç­–ç•¥
           Strategy ->> Parser: parse(resource)
           Parser -->> Loader: List<DictInfo>
           Loader ->> Cache: å­˜å‚¨å­—å…¸æ¡ç›®
       end
       Note over App,Cache: æŸ¥è¯¢é˜¶æ®µ
       App ->> Loader: get(lang, dictKey)
       Loader ->> Cache: æŸ¥æ‰¾å€¼
       Cache -->> App: å­—å…¸å€¼
       App -->> App: Optional<String>
   ```

### ğŸ§© æ–‡ä»¶æ ¼å¼æ‰©å±•

æ–‡ä»¶åŠ è½½å™¨é€šè¿‡ [DictFileParser](../../../dict-i18n-loader/dict-i18n-loader-core/src/main/java/cn/silwings/dicti18n/loader/parser/DictFileParser.java)
ç»„ä»¶å®ç°å®é™…çš„æ•°æ®è§£æåŠŸèƒ½ï¼Œç³»ç»Ÿé»˜è®¤å·²æ”¯æŒ yml å’Œ properties æ ¼å¼æ–‡ä»¶çš„è§£æã€‚

è‹¥éœ€æ‰©å±•æ”¯æŒè‡ªå®šä¹‰æ–‡ä»¶æ ¼å¼ï¼ˆå¦‚ jsonã€xml
ç­‰ï¼‰ï¼Œå¯é€šè¿‡å®ç° [DictFileParseStrategy](../../../dict-i18n-loader/dict-i18n-loader-core/src/main/java/cn/silwings/dicti18n/loader/parser/strategy/DictFileParseStrategy.java)
æ¥å£å®Œæˆï¼š

```java
public interface DictFileParseStrategy {

    boolean supports(Resource resource);

    List<DictInfo> parse(Resource resource);
}
```

å®ç°ç±»åªéœ€æ³¨å…¥ Spring å®¹å™¨ï¼Œç³»ç»Ÿå³å¯è‡ªåŠ¨è¯†åˆ«å¹¶å¯ç”¨è¯¥è§£æç­–ç•¥ã€‚

---

## ğŸ§® æ•°æ®åº“åŠ è½½å™¨ï¼ˆsqlï¼‰

* **åŠŸèƒ½**ï¼šä»æ•°æ®åº“è¡¨ä¸­æŸ¥è¯¢å­—å…¸æ•°æ®
* **ç¼“å­˜**: é‡‡ç”¨å†…å­˜ç¼“å­˜ï¼Œé»˜è®¤å®ç°åŸºäº google.guava
* **å·¥ä½œæµç¨‹**:

  é¡¹ç›®å¯åŠ¨é˜¶æ®µ:

  - sql åŠ è½½å™¨å…ˆæ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼š
  - è‹¥å¼€å¯ schema é…ç½®ï¼Œä¼šè‡ªåŠ¨åœ¨æ•°æ®åº“ä¸­åˆ›å»ºå¿…è¦çš„è¡¨ç»“æ„åŠç´¢å¼•ï¼Œç›®å‰æ”¯æŒ MySQLã€PostgreSQLã€SQLiteï¼›
  - è‹¥å¼€å¯ preload é…ç½®ï¼Œä¼šæ‰«æ resource ç›®å½•ä¸‹ç¬¦åˆå‘½åæ¨¡å¼ï¼ˆdict_i18n/dict_{locale} æˆ– dict_i18n/dictï¼‰çš„ yml æˆ–
    properties æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„å­—å…¸ç¿»è¯‘æ•°æ®è½¬æ¢ä¸º INSERT è¯­å¥å¹¶æ’å…¥æ•°æ®åº“ã€‚

  æŸ¥è¯¢é˜¶æ®µï¼š

  - è‹¥å¯ç”¨ç¼“å­˜ï¼ŒåŠ è½½å™¨ä¼šä¼˜å…ˆä»ç¼“å­˜è¯»å–æ•°æ®ï¼›ç¼“å­˜æœªå‘½ä¸­æ—¶åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†ç»“æœï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰å­˜å…¥ç¼“å­˜ï¼›
  - è‹¥æœªå¯ç”¨ç¼“å­˜ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¿”å›ç»“æœã€‚

    > è¡¥å……è¯´æ˜ï¼šè‹¥ä½¿ç”¨æœªæ”¯æŒçš„æ•°æ®åº“ï¼Œå¯æ‰‹åŠ¨åˆ›å»ºè¡¨ç»“æ„ï¼Œå‚è€ƒ SQL å¦‚ä¸‹ï¼š
    >   ```sql
      >    CREATE TABLE dict_i18n
      >    (
      >    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
      >    dict_key    VARCHAR(512)  NOT NULL,
      >    lang        VARCHAR(10)   NOT NULL,
      >    description VARCHAR(1024) NOT NULL,
      >    enabled     TINYINT       NOT NULL DEFAULT 1 COMMENT 'Enable or not: 1-Enable, 0-Disable',
      >    UNIQUE KEY uidx_dicti18n_dictkey_lang (dict_key, lang)
      >    ) ENGINE=InnoDB;
      >   CREATE INDEX idx_dicti18n_dictkey ON dict_i18n (dict_key);
      >   CREATE INDEX idx_dicti18n_lang ON dict_i18n (lang);
      >   ```

    ```mermaid
    sequenceDiagram
    title SQLåŠ è½½å™¨åŠ è½½ä¸æŸ¥è¯¢æµç¨‹
    participant App as Application
    participant SchemaInit as DictI18nSchemaInitializer
    participant Preload as DictI18nSqlDataInitializer
    participant Parser as DictFileParser
    participant Cache as DictI18nLoaderCacheProvider
    participant Loader as SqlDictI18nLoader
    participant DB as Database (MySQL/PostgreSQL/SQLite)
    participant Resources as Resource Files

    Note over App,Resources: é¡¹ç›®å¯åŠ¨é˜¶æ®µ
    App->>SchemaInit: åˆå§‹åŒ–SQLåŠ è½½å™¨
    SchemaInit->>SchemaInit: æ£€æŸ¥æ˜¯å¦å¼€å¯schemaé…ç½®
    alt schemaå¼€å¯
      SchemaInit->>DB: æ‰§è¡Œå»ºè¡¨è¯­å¥
      DB-->>SchemaInit: æ“ä½œæˆåŠŸ
      DB-->>SchemaInit: æ“ä½œæˆåŠŸ
    end

    Preload->>Preload: æ£€æŸ¥æ˜¯å¦å¼€å¯preloadé…ç½®
    alt preloadå¼€å¯
      Preload->>Resources: æ‰«æç¬¦åˆæ¨¡å¼çš„æ–‡ä»¶
      Resources-->>Preload: è¿”å›åŒ¹é…çš„èµ„æºæ–‡ä»¶åˆ—è¡¨
      loop å¤„ç†æ¯ä¸ªèµ„æºæ–‡ä»¶
        Preload->>Parser: è§£ææ–‡ä»¶å†…å®¹
        Parser-->>Preload: è¿”å›è§£æåçš„å­—å…¸æ•°æ®
        Preload->>DB: æ‰§è¡ŒINSERTè¯­å¥
        DB-->>Preload: æ“ä½œæˆåŠŸ
      end
    end

    Preload-->>Loader: åŠ è½½å™¨å‡†å¤‡å°±ç»ª
    Note over App,DB: æŸ¥è¯¢é˜¶æ®µ
    App->>Loader: è¯·æ±‚ç¿»è¯‘æ•°æ®(langChain, dictKey)
    Loader->>Cache: æ£€æŸ¥æ˜¯å¦å¼€å¯ç¼“å­˜
    alt ç¼“å­˜å¼€å¯
      Loader->>Cache: ä»ç¼“å­˜è·å–æ•°æ®(langChain, dictKey)
      Cache-->>Loader: è¿”å›ç¼“å­˜æ•°æ®(å¯èƒ½ä¸ºç©º)
      alt ç¼“å­˜å‘½ä¸­(åŒ…æ‹¬ç©ºå€¼)
        Loader-->>App: è¿”å›ç¼“å­˜æ•°æ®
      else ç¼“å­˜æœªå‘½ä¸­
        Loader->>DB: æ‰§è¡ŒæŸ¥è¯¢è¯­å¥
        DB-->>Loader: è¿”å›æŸ¥è¯¢ç»“æœ(å¯èƒ½ä¸ºç©º)
        Loader->>Cache: å°†ç»“æœå­˜å…¥ç¼“å­˜(æ”¯æŒç©ºå€¼)
        Cache-->>Loader: ç¼“å­˜å®Œæˆ
        Loader-->>App: è¿”å›æŸ¥è¯¢ç»“æœ
      end
    else ç¼“å­˜æœªå¼€å¯
      Loader->>DB: æ‰§è¡ŒæŸ¥è¯¢è¯­å¥
      DB-->>Loader: è¿”å›æŸ¥è¯¢ç»“æœ
      Loader-->>App: è¿”å›æŸ¥è¯¢ç»“æœ
    end
    ```    

### ğŸ§  ç¼“å­˜æœºåˆ¶

SQL åŠ è½½å™¨é»˜è®¤å¯ç”¨ç¼“å­˜ï¼ˆè‡ª 1.0.2 ç‰ˆæœ¬èµ·ï¼‰ï¼Œé€šè¿‡å‡å°‘å¯¹æ•°æ®åº“çš„é¢‘ç¹è®¿é—®æ¥æå‡ç³»ç»Ÿæ€§èƒ½ã€‚

è‹¥éœ€è‡ªå®šä¹‰ç¼“å­˜ç­–ç•¥ï¼ˆå¦‚ç»“åˆ Redis
å®ç°åˆ†å¸ƒå¼ç¼“å­˜ã€é…ç½®å®šæ—¶åˆ·æ–°è§„åˆ™ç­‰ï¼‰ï¼Œå¯é€šè¿‡å®ç° [DictI18nLoaderCacheProvider](../../../dict-i18n-loader/dict-i18n-loader-core/src/main/java/cn/silwings/dicti18n/loader/cache/DictI18nLoaderCacheProvider.java)
æ¥å£æ‰©å±•ï¼š

```java
public interface DictI18nLoaderCacheProvider {

    Optional<String> getDesc(String lang, String key, DictDescGetter descGetter);
}
```

å°†å®ç°ç±»æ³¨å†Œä¸º Spring Bean åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜æä¾›å™¨æ›¿æ¢é»˜è®¤çš„å†…å­˜ç¼“å­˜å®ç°ã€‚

---

## ğŸ§° Redis åŠ è½½å™¨ï¼ˆredisï¼‰

* **åŠŸèƒ½**ï¼šä» Redis ä¸­è·å–å­˜å‚¨çš„å­—å…¸æ•°æ®
* **ç¼“å­˜**ï¼šå›  Redis æœ¬èº«å…·å¤‡é«˜æ€§èƒ½åˆ†å¸ƒå¼ç¼“å­˜ç‰¹æ€§ï¼Œæ•…æœªé¢å¤–å åŠ ç¼“å­˜å±‚
* **å·¥ä½œæµç¨‹**ï¼š

  é¡¹ç›®å¯åŠ¨é˜¶æ®µ: è‹¥å¼€å¯ preload é…ç½®ï¼ŒRedis åŠ è½½å™¨ä¼šæ‰«æ resource ç›®å½•ä¸‹ç¬¦åˆå‘½åæ¨¡å¼ï¼ˆdict_i18n/dict_{locale} æˆ–
  dict_i18n/dictï¼‰çš„ yml æˆ– properties æ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„å­—å…¸ç¿»è¯‘æ•°æ®é€šè¿‡ Lua è„šæœ¬æ‰¹é‡å†™å…¥ Redisï¼›

  è¯»å–é˜¶æ®µ: åŠ è½½å™¨ç›´æ¥ä» Redis ä¸­è·å–ç¿»è¯‘æ•°æ®å¹¶è¿”å›ã€‚

  ```mermaid
  sequenceDiagram
  title RedisåŠ è½½å™¨åŠ è½½ä¸æŸ¥è¯¢æµç¨‹
  participant App as Application
  participant Preload as DictI18nRedisDataInitializer
  participant Parser as DictFileParser
  participant Loader as RedisDictI18nLoader
  participant Redis as Redis
  participant Resources as Resource Files
  
  Note over App,Resources: é¡¹ç›®å¯åŠ¨é˜¶æ®µ
  App->>Preload: åˆå§‹åŒ–RedisåŠ è½½å™¨
  Preload->>Preload: æ£€æŸ¥æ˜¯å¦å¼€å¯preloadé…ç½®
  alt preloadå¼€å¯
  Preload->>Resources: æ‰«æç¬¦åˆæ¨¡å¼çš„æ–‡ä»¶
  Resources-->>Preload: è¿”å›åŒ¹é…çš„èµ„æºæ–‡ä»¶åˆ—è¡¨
  loop å¤„ç†æ¯ä¸ªèµ„æºæ–‡ä»¶
  Preload->>Parser: è§£ææ–‡ä»¶å†…å®¹
  Parser-->>Preload: è¿”å›è§£æåçš„å­—å…¸æ•°æ®
  Preload->>Preload: ç”ŸæˆLuaè„šæœ¬(ç”¨äºæ‰¹é‡æ’å…¥)
  Preload->>Redis: æ‰§è¡ŒLuaè„šæœ¬æ’å…¥æ•°æ®
  Redis-->>Preload: æ•°æ®æ’å…¥å®Œæˆ
  end
  end
  
  Preload-->>Loader: åŠ è½½å™¨å‡†å¤‡å°±ç»ª
  Note over App,Redis: è¯»å–é˜¶æ®µ
  App->>Loader: è¯·æ±‚ç¿»è¯‘æ•°æ®(langChain, dictKey)
  Loader->>Redis: ä»Redisè·å–ç¿»è¯‘æ•°æ®
  Redis-->>Loader: è¿”å›æŸ¥è¯¢ç»“æœ(å¯èƒ½ä¸ºç©º)
  Loader-->>App: è¿”å›ç¿»è¯‘æ•°æ®
  ```

---

## ğŸ§¾ å£°æ˜å¼åŠ è½½å™¨ï¼ˆdeclaredï¼‰

* **åŠŸèƒ½**:
  é€šè¿‡å®ç° [DeclaredDict](../../../dict-i18n-loader/dict-i18n-loader-declared/src/main/java/cn/silwings/dicti18n/loader/declared/dict/DeclaredDict.java)
  æ¥å£ï¼Œæˆ–ä¸º Dict æ¥å£çš„å®ç°ç±»æ·»åŠ  `getDesc` æ–¹æ³•ï¼Œä½¿æ¡†æ¶å¯ç›´æ¥è°ƒç”¨ Java å¯¹è±¡çš„æ–¹æ³•è·å–æè¿°ä¿¡æ¯ã€‚
* **ä½¿ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºé™æ€å­—å…¸ã€éœ€é€šè¿‡ä»£ç é€»è¾‘åŠ¨æ€ç”Ÿæˆæè¿°çš„å­—å…¸ï¼Œæˆ–æµ‹è¯•åœºæ™¯ä¸­éœ€å¿«é€Ÿé…ç½®çš„å­—å…¸æ•°æ®ã€‚
* **æ³¨æ„äº‹é¡¹**: declared åŠ è½½å™¨åœ¨è¯»å–å­—å…¸æè¿°æ—¶ä¼šå¿½ç•¥è¯­è¨€ä¿¡æ¯, å¦‚æœ‰éœ€è¦å¯è‡ªè¡Œåœ¨ getDesc æ–¹æ³•ä¸­å®ç°ã€‚
* **å·¥ä½œæµç¨‹**:

  é¡¹ç›®å¯åŠ¨é˜¶æ®µï¼Œdeclared åŠ è½½å™¨æ‰«æè¿è¡Œæ—¶ç±»è·¯å¾„ï¼Œç­›é€‰å‡ºæ‰€æœ‰å®ç° Dict æ¥å£çš„æšä¸¾ç±»ä¸ Java Beanï¼›åˆå§‹åŒ–ç¨‹åºä¼šå°†è¿™äº›ç±»å®ä¾‹åŒ–å¹¶ç¼“å­˜è‡³å†…å­˜ã€‚

  æŸ¥è¯¢é˜¶æ®µï¼ŒåŠ è½½å™¨ä»å†…å­˜ä¸­è·å– Dict å®ä¾‹åï¼š

  - è‹¥ä¸º DeclaredDict å®ç°ç±»ï¼Œç›´æ¥è°ƒç”¨å…¶ getDesc() æ–¹æ³•ï¼›
  - è‹¥é DeclaredDict å®ç°ç±»ï¼Œé€šè¿‡åå°„æŸ¥æ‰¾ getDesc() æ–¹æ³•ï¼Œæ‰¾åˆ°åˆ™è°ƒç”¨ï¼›
  - è‹¥ä¸ºæšä¸¾ï¼Œè¿”å›æšä¸¾å€¼åç§°;
  - è¿”å›ç©ºã€‚

   ```mermaid
   sequenceDiagram
  title DeclaredåŠ è½½å™¨åŠ è½½ä¸æŸ¥è¯¢æµç¨‹
  participant App as Application
  participant Loader as DeclaredDictI18nLoader
  participant Scanner as DictScanner
  participant DictImpl as Dict/DeclaredDictå®ç°ç±»<br/>(Enum/Java Bean)
  participant Cache as Non-expired cache

  Note over App,Cache: é¡¹ç›®å¯åŠ¨é˜¶æ®µ
  App->>Loader: åˆå§‹åŒ–DeclaredåŠ è½½å™¨
  Loader->>Scanner: æ‰«æè¿è¡Œæ—¶ç±»è·¯å¾„
  Scanner->>Scanner: æŸ¥æ‰¾æ‰€æœ‰å®ç°Dictæ¥å£çš„ç±»<br/>(æšä¸¾å’ŒJava Bean)
  Scanner-->>Loader: è¿”å›åŒ¹é…çš„ç±»åˆ—è¡¨
  loop å¤„ç†æ¯ä¸ªDictå®ç°ç±»
    Loader->>DictImpl: å®ä¾‹åŒ–ç±»
    DictImpl-->>Loader: è¿”å›å®ä¾‹å¯¹è±¡
    Loader->>Cache: å°†å®ä¾‹ç¼“å­˜åˆ°å†…å­˜
    Cache-->>Loader: ç¼“å­˜å®Œæˆ
  end
  
  Loader-->>Loader: åŠ è½½å™¨å‡†å¤‡å°±ç»ª
  Note over App,Cache: æŸ¥è¯¢é˜¶æ®µ
  App->>Loader: è¯·æ±‚ç¿»è¯‘æ•°æ®(dictKey)
  Loader->>Cache: ä»å†…å­˜è·å–Dictå®ä¾‹
  Cache-->>Loader: è¿”å›Dictå®ä¾‹
  Loader->>Loader: æ£€æŸ¥æ˜¯å¦ä¸ºDeclaredDictå®ç°ç±»
  alt æ˜¯DeclaredDictå®ç°ç±»
    Loader->>DictImpl: è°ƒç”¨getDesc()æ–¹æ³•
    DictImpl-->>Loader: è¿”å›æè¿°ä¿¡æ¯
  else ä¸æ˜¯DeclaredDictå®ç°ç±»
    Loader->>Loader: é€šè¿‡åå°„æŸ¥æ‰¾getDesc()æ–¹æ³•
    alt æ‰¾åˆ°getDesc()æ–¹æ³•
      Loader->>DictImpl: åå°„è°ƒç”¨getDesc()
      DictImpl-->>Loader: è¿”å›æè¿°ä¿¡æ¯
    else æœªæ‰¾åˆ°getDesc()æ–¹æ³•
       alt æ˜¯æšä¸¾ç±»å‹
            Loader->>Loader: è¿”å›æšä¸¾å€¼åç§°
        else ä¸æ˜¯æšä¸¾ç±»å‹
            Loader->>Loader: è¿”å›ç©º
        end    
    end
  end
  Loader-->>App: è¿”å›ç¿»è¯‘ç»“æœ
   ```

DeclaredDictç¤ºä¾‹å®ç°ï¼š

```java
public enum PaymentType implements DeclaredDict {

  WECHAT {
    @Override
    public String getDesc() {
      return "å¾®ä¿¡";
    }
  },
  ALIPAY {
    @Override
    public String getDesc() {
      return "æ”¯ä»˜å®";
    }
  };

  @Override
  public String dictName() {
    return "payment_type";
  }

  @Override
  public String code() {
    return this.name();
  }
}
```

---

## ğŸ§© åŠ è½½å™¨ç›¸å…³æ‰©å±•ç»„ä»¶æ€»è§ˆ

| ç»„ä»¶æ¥å£                          | åŠŸèƒ½æè¿°	                           | é€‚ç”¨åŠ è½½å™¨              |
|-------------------------------|---------------------------------|--------------------|
| `DictI18nLoader`              | å®šä¹‰å­—å…¸åŠ è½½å™¨çš„ç»Ÿä¸€æ¥å£è§„èŒƒï¼Œæ‰€æœ‰åŠ è½½å™¨çš„åŸºç¡€æ¥å£       | æ‰€æœ‰åŠ è½½å™¨              |
| `DictFileParseStrategy`       | æ‰©å±•å­—å…¸æ–‡ä»¶è§£æèƒ½åŠ›ï¼Œæ”¯æŒæ›´å¤šæ ¼å¼ï¼ˆå¦‚ jsonã€xml ç­‰ï¼‰ | file / redis / sql |
| `DictI18nLoaderCacheProvider` | æä¾›è‡ªå®šä¹‰ç¼“å­˜å®ç°æ–¹æ¡ˆï¼Œå¯æ›¿æ¢é»˜è®¤ç¼“å­˜ç­–ç•¥           | sql                |

### è‡ªå®šä¹‰åŠ è½½å™¨

æœ€å…·æ‰©å±•æ€§çš„ç‚¹æ˜¯åˆ›å»ºè‡ªå®šä¹‰å­—å…¸åŠ è½½å™¨ï¼Œä»¥ä»ä¸åŒæ¥æºåŠ è½½å­—å…¸æ•°æ®, è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªä»REST APIåŠ è½½å­—å…¸æ•°æ®çš„ç®€å•è‡ªå®šä¹‰åŠ è½½å™¨ï¼š

æ ¸å¿ƒæ¥å£:

```java
public interface DictI18nLoader {

  /**
   * åŠ è½½å™¨åç§°,å¿…é¡»å”¯ä¸€
   */
  String loaderName();


  /**
   * æ ¹æ®è¯­è¨€å’Œé”®è·å–ç¿»è¯‘
   *
   * @param lang    å°å†™è¯­è¨€
   * @param dictKey å­—å…¸é”®
   * @return translation è¯‘æ–‡
   */
  Optional<String> get(String lang, String dictKey);
}
```

å®ç°è‡ªå®šä¹‰åŠ è½½å™¨:

```java
@Component
public class RestApiDictI18nLoader implements DictI18nLoader {

    private final RestTemplate restTemplate;
    private final String apiUrl;
    private final Map<String, Map<String, String>> cache = new ConcurrentHashMap<>();

    public RestApiDictI18nLoader(final RestTemplate restTemplate, @Value("${dict-i18n.loader.rest.url}") String apiUrl) {
        this.restTemplate = restTemplate;
        this.apiUrl = apiUrl;
    }

    @Override
    public String loaderName() {
        // æ­¤åŠ è½½å™¨çš„å”¯ä¸€åç§°
        return "rest";
    }

    @Override
    public Optional<String> get(final String lang, final String dictKey) {
        if (null == lang || null == dictKey) {
            return Optional.empty();
        }

        // è·å–æ­¤è¯­è¨€çš„å­—å…¸æ•°æ®ï¼Œå¿…è¦æ—¶åŠ è½½
        final Map<String, String> langDict = this.cache.computeIfAbsent(lang, this::loadDictionaryForLanguage);

        // å¦‚æœå¯ç”¨ï¼Œè¿”å›ç¿»è¯‘
        return Optional.ofNullable(langDict.get(dictKey));
    }

    private Map<String, String> loadDictionaryForLanguage(final String lang) {
        try {
            // è°ƒç”¨REST APIè·å–æ­¤è¯­è¨€çš„å­—å…¸æ•°æ®
            final String url = this.apiUrl + "?lang=" + lang;
            final DictionaryResponse response = this.restTemplate.getForObject(url, DictionaryResponse.class);

            if (null != response && response.isSuccess()) {
                return response.getData();
            }
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        }
        return new HashMap<>();
    }

    // APIçš„ç®€å•å“åº”ç±»
    private static class DictionaryResponse {
        private boolean success;
        private Map<String, String> data;

        // Getters, setters...

        public boolean isSuccess() {
            return success;
        }

        public Map<String, String> getData() {
            return data;
        }
    }
}
```

å®Œæˆåè®°å¾—è°ƒæ•´é…ç½®æ–‡ä»¶ä½¿å¾—è‡ªå®šä¹‰åŠ è½½å™¨æŒ‰éœ€è¦çš„é¡ºåºæ‰§è¡Œ.

---

## ğŸ§  åŠ è½½å™¨é¡ºåºæ§åˆ¶ï¼ˆloader-orderï¼‰

ä½ å¯ä»¥é€šè¿‡é…ç½®é¡¹ `dict-i18n.loader-order` æ˜¾å¼å£°æ˜åŠ è½½å™¨çš„æ‰§è¡Œä¼˜å…ˆçº§é¡ºåºï¼Œç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š

```yaml
dict-i18n:
  loader-order:
    - redis
    - sql
    - file
    - declared
```

é…ç½®ä¸­é å‰çš„åŠ è½½å™¨å°†ä¼˜å…ˆç”Ÿæ•ˆï¼šå½“ä¼˜å…ˆçº§é«˜çš„åŠ è½½å™¨æœªæŸ¥è¯¢åˆ°å­—å…¸æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨åç»­åŠ è½½å™¨è¿›è¡Œè¡¥å……æŸ¥è¯¢ï¼Œç›´è‡³è·å–åˆ°æœ‰æ•ˆæ•°æ®æˆ–éå†å®Œæ‰€æœ‰åŠ è½½å™¨ã€‚

**è¯´æ˜**ï¼šæ­¤æœºåˆ¶é€šè¿‡é¡ºåºæ‰§è¡Œç­–ç•¥å®ç°å­—å…¸æ•°æ®çš„å¤šå±‚çº§è¦†ç›–ä¸è¡¥å……ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å¤æ‚åœºæ™¯ä¸‹èƒ½çµæ´»é€‚é…ä¸åŒæ•°æ®æºçš„æŸ¥è¯¢éœ€æ±‚ã€‚

| [< å¯åŠ¨å™¨è¯´æ˜](../starter/å¯åŠ¨å™¨è¯´æ˜.md) | [é…ç½®è¯´æ˜ >](../config/é…ç½®è¯´æ˜.md) |
|:-------------------------------|----------------------------:|